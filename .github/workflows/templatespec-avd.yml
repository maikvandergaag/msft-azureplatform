name: Template spec - Azure Virtual Desktop
 
on:
  push:
    paths:
      - 'templatespec/avd/*'
      - .github/workflows/templatespec-avd.yml
      - .module/avd-backplane.bicep
    branches: [ main ]
  pull_request:
    branches: [ main ]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

env:
  specName: az-tempspec-avd
  specfolder: './templatespec/avd/avd'
  specfilename: avd.json
  resourcegroup: gaag-rg-templates

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - run: | 
          curl -Lo bicepinstall https://github.com/Azure/bicep/releases/latest/download/bicep-linux-x64
          chmod +x ./bicepinstall
          sudo mv ./bicepinstall /usr/local/bin/bicep
          bicep --help
      - run:    bicep build ${{env.specfolder}}.bicep
      - name: Archive production specs
        uses: actions/upload-artifact@v2
        with:
          name: ${{env.specName}}
          path: ${{env.specfolder}}.json
      - name: Archive production scripts
        uses: actions/upload-artifact@v2
        with:
          name: ps-${{env.specName}}
          path: ./utilities/*.ps1
  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
       - uses: actions/download-artifact@v2
         name: Download template spec
         with:
             name: ${{env.specName}}
       - uses: actions/download-artifact@v2
         name: Download utility scripts
         with:
             name: ps-${{env.specName}}
       - name: Azure Login
         uses: Azure/login@v1
         with:
           creds: ${{ secrets.AZURE_CREDENTIALS_MANAGEMENTGROUP }}
           enable-AzPSSession: true 
       - name: Check versionnumber
         uses: azure/powershell@v1
         id: calculate
         with:
           inlineScript: |
              .\Get-TemplateSpecVersion.ps1 -TemplateSpecName "${{env.specName}}" -ResourceGroupName "${{env.resourcegroup}}"
           azPSVersion: '6.1.0'
       - name: Create / Update template spec
         uses: azure/powershell@v1
         with:
           inlineScript: |
            New-AzTemplateSpec -Name "${{env.specName}}" -Version "${{ steps.calculate.outputs.versionnumber }}" -ResourceGroupName "${{env.resourcegroup}}" -Location "westeurope" -TemplateFile ".\${{env.specfilename}}"
           azPSVersion: '6.1.0'


 

 